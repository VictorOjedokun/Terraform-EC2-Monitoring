name: Deploy Flask App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'The environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options: [production, qa, dev]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write SSH key and verify connection
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" 'echo Connected'

      - name: Ensure base packages on EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            set -e
            sudo apt-get update -y
            sudo apt-get install -y python3 python3-venv python3-pip rsync
          "

      - name: Create app directory and set ownership
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            set -e
            sudo mkdir -p /opt/flask-app
            sudo chown -R ubuntu:ubuntu /opt/flask-app
          "

      - name: Sync project files to EC2 (rsync)
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          rsync -avz --delete             --exclude '.git' --exclude '__pycache__' --exclude '.github'             -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"             ./ ubuntu@"$HOST":/opt/flask-app/

      - name: Create/refresh venv & install dependencies (absolute path)
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            set -euo pipefail
            sudo mkdir -p /opt/flask-app
            sudo chown -R ubuntu:ubuntu /opt/flask-app
            python3 -m venv /opt/flask-app/venv || true
            /opt/flask-app/venv/bin/python -m pip install --upgrade pip
            [ -f /opt/flask-app/requirements.txt ] && /opt/flask-app/venv/bin/pip install -r /opt/flask-app/requirements.txt || true
            /opt/flask-app/venv/bin/pip install gunicorn
          "

      - name: Create/refresh systemd unit (flask-app.service)
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            set -e
            sudo bash -s <<'EOF'
            cat >/etc/systemd/system/flask-app.service <<'UNIT'
            [Unit]
            Description=Flask Application (Gunicorn)
            After=network-online.target
            Wants=network-online.target

            [Service]
            User=ubuntu
            Group=ubuntu
            WorkingDirectory=/opt/flask-app
            Environment=PYTHONUNBUFFERED=1
            # If your entry is wsgi.py, change to wsgi:app
            ExecStart=/opt/flask-app/venv/bin/gunicorn --workers 3 --chdir /opt/flask-app --bind 0.0.0.0:5000 app:app
            Restart=always
            RestartSec=3
            ExecStartPre=/usr/bin/test -x /opt/flask-app/venv/bin/gunicorn
            ExecStartPre=/usr/bin/test -f /opt/flask-app/app.py

            [Install]
            WantedBy=multi-user.target
            UNIT

            systemctl daemon-reload
            systemctl enable flask-app
            systemctl restart flask-app
            systemctl status flask-app --no-pager || true
            EOF
          "

      - name: Diagnose service on EC2
        if: always()
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            set -e
            echo '=== systemctl status ==='
            sudo systemctl status flask-app --no-pager || true
            echo
            echo '=== last 200 logs ==='
            sudo journalctl -u flask-app -n 200 --no-pager || true
            echo
            echo '=== listening sockets ==='
            sudo ss -lntp | sed -n '1,200p' | cat || true
            echo
            echo '=== processes mentioning gunicorn ==='
            ps aux | grep -i gunicorn | grep -v grep || true
            echo
            echo '=== file layout ==='
            ls -la /opt/flask-app || true
          "

      - name: Health Check (retry on /health then /)
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Checking app health..."
          for i in {1..10}; do
            if curl -fsS "http://$HOST:5000/health" >/dev/null; then
              echo "✅ /health OK"; exit 0
            fi
            if curl -fsS "http://$HOST:5000/" >/dev/null; then
              echo "✅ / OK"; exit 0
            fi
            echo "Waiting for app... ($i/10)"
            sleep 3
          done
          echo "❌ App not healthy"; exit 1

      - name: Show Flask logs on failure
        if: failure()
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@"$HOST" "
            sudo systemctl status flask-app --no-pager || true
            sudo journalctl -u flask-app -n 200 --no-pager || true
          "
